<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Kitap Listesi</title>
    <style>
        body
        {
            margin:0;
            height:100vh;
            display:flex;
            font-family:Segoe UI, sans-serif;
            background:#f3f4f6;
        }

        .sidebar
        {
            width:220px;
            background:#1f2933;
            color:white;
            padding:20px;
        }

        .sidebar h2
        {
            text-align:center;
            margin-bottom:30px;
        }

        .sidebar button
        {
            width:100%;
            padding:12px;
            margin:8px 0;
            background:none;
            border:none;
            color:white;
            text-align:left;
            cursor:pointer;
        }

        .sidebar button:hover
        {
            background:#374151;
        }

        .logout
        { 
            background:#b91c1c !important; 
        }

        .content
        {
            flex:1;
            padding:25px;
            display:flex;
            flex-direction:column;
        }

        .page-title
        {
            font-size:32px;
            margin-bottom:15px;
            text-align:center;
            width:100%;
        }

        #kitapTablosu
        {
            flex:1;
            background:white;
            padding:20px;
            border-radius:16px;
            box-shadow:0 6px 18px rgba(0,0,0,.15);
            overflow:auto;
        }
        table
        { 
            width:100%; border-collapse:collapse; 
        }
        
        th,td
        {
            padding:12px 15px;
            border-bottom:1px solid #e5e7eb;
        }

        th
        {
            background:#2563eb;
            color:white;
        }

        tr:nth-child(even)
        {
            background:#f9fafb;
        }

        .bottom-controls
        {
            margin-top:20px;
            background:white;
            padding:18px 22px;
            border-radius:16px;
            box-shadow:0 4px 12px rgba(0,0,0,.15);
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:20px;
        }

        #aramaKutusu
        {
            flex:1;
            padding:12px 15px;
            font-size:16px;
            border-radius:10px;
            border:1px solid #cbd5e1;
        }

        .page-buttons
        {
            display:flex;
            gap:10px;
        }

        .sayfa-btn
        {
            padding:10px 18px;
            background:#2563eb;
            color:white;
            border:none;
            border-radius:10px;
            cursor:pointer;
        }

        .sayfa-btn:disabled
        {
            background:#94a3b8;
        }

        #oduncBtn
        {
            padding:12px 22px;
            font-size:16px;
            border:none;
            border-radius:12px;
            background:#16a34a;
            color:white;
            cursor:pointer;
        }

        #oduncBtn:hover
        {
            background:#15803d;
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>√úye Paneli</h2>
        <button onclick="window.location.href='{{url_for('user.kitaplarSayfasi')}}'">üìö Kitaplar</button>
        <button onclick="window.location.href='{{url_for('user.kitaplarim')}}'">üìñ Kitaplarƒ±m</button>
        <button>‚ö†Ô∏è Ceza Bilgi</button>
        <button class="logout" onclick="window.location.href='{{url_for('user.logout')}}'">üö™ √áƒ±kƒ±≈ü</button>
    </div>
    <div class="content">

        <div class="page-title">K√ºt√ºphane Kitaplarƒ±</div>

        <div id="kitapTablosu">
            <p>Kitaplar y√ºkleniyor...</p>
        </div>

        <div class="bottom-controls">

            <input type="text" id="aramaKutusu" placeholder="Kitap adƒ± ara...">
            <div class="page-buttons">
                <button class="sayfa-btn" id="prevBtn" disabled>‚óÄ √ñnceki</button>
                <button class="sayfa-btn" id="nextBtn">Sonraki ‚ñ∂</button>
            </div>
            <button id="oduncBtn">√ñd√ºn√ß Al</button>

        </div>
    </div>
    <script>
        let tumKitaplar = [];
        let goruntulenecek = [];
        let sayfa = 0;
        const LIMIT = 10;
        let seciliKitaplar = [];
        let mevcutOduncSayisi = 0;

        function kitaplariYukle() 
        {
            fetch("/kitap-sayim")
            .then(r => r.json())
            .then(data => {
                mevcutOduncSayisi = data["Kitap Sayƒ±sƒ±"];
            });

            fetch("/kitaplar")
            .then(res => res.json())
            .then(data => {
                tumKitaplar = data.filter(k => k.stock > 0);
                goruntulenecek = tumKitaplar;
                sayfa = 0;
                tabloCiz();
            });
        }

        function checkboxDegisti(kitapId) 
        {
            kitapId = Number(kitapId);
            if (!seciliKitaplar.includes(kitapId)) 
            {
                seciliKitaplar.push(kitapId);
            } 
            else 
            {
                seciliKitaplar = seciliKitaplar.filter(id => id != kitapId);
            }
        }

        function tabloCiz() 
        {
            let start = sayfa * LIMIT;
            let end = start + LIMIT;
            let parcaliListe = goruntulenecek.slice(start, end);

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Se√ß</th>
                            <th>Kitap Adƒ±</th>
                            <th>Yazar</th>
                            <th>Yayƒ±nevi</th>
                            <th>Kategori</th>
                            <th>Stok</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            parcaliListe.forEach(row => {
                html += `
                    <tr>
                        <td><input type="checkbox" onchange="checkboxDegisti('${row.bookID}')"></td>
                        <td>${row.bookName}</td>
                        <td>${row.authorName}</td>
                        <td>${row.publisher}</td>
                        <td>${row.categoryName}</td>
                        <td>${row.stock}</td>
                    </tr>
                `;
            });

            html += "</tbody></table>";
            document.getElementById("kitapTablosu").innerHTML = html;

            document.getElementById("prevBtn").disabled = sayfa === 0;
            document.getElementById("nextBtn").disabled = end >= goruntulenecek.length;
        }

        document.getElementById("aramaKutusu").addEventListener("input", function () 
        {
            let arama = this.value.toLowerCase();
            goruntulenecek = tumKitaplar.filter(k => k.bookName.toLowerCase().includes(arama));
            sayfa = 0;
            tabloCiz();
        });

        document.getElementById("prevBtn").addEventListener("click", function () 
        {
            if (sayfa > 0) {
                sayfa--;
                tabloCiz();
            }
        });

        document.getElementById("nextBtn").addEventListener("click", function () 
        {
            if ((sayfa + 1) * LIMIT < goruntulenecek.length) {
                sayfa++;
                tabloCiz();
            }
        });

        document.getElementById("oduncBtn").addEventListener("click", function () 
        {
            if (seciliKitaplar.length == 0) 
            {
                alert("L√ºtfen en az 1 kitap se√ß!");
                return;
            }

            let toplam = mevcutOduncSayisi + seciliKitaplar.length;
            if (toplam > 3) 
            {
                let kalan = 3 - mevcutOduncSayisi;
                alert(`≈ûu anda ${mevcutOduncSayisi} kitabƒ±nƒ±z var. En fazla ${kalan} tane daha alabilirsiniz.`);
                return;
            }

            fetch("/odunc-al", 
            {
                method:"POST",
                headers:{ "Content-Type":"application/json" },
                body:JSON.stringify({ bookIDs: seciliKitaplar })
            })
            .then(res=>res.json())
            .then(data=>{
                alert(data.message);
                seciliKitaplar=[];
                kitaplariYukle();
            });
        });
        window.onload = kitaplariYukle;
    </script>
</body>
</html>