<!DOCTYPE html>
<html lang="tr">
    <head>
        <meta charset="UTF-8">
        <title>Hesap Bilgileri</title>
        <style>
            body
            {
                margin:0;
                height:100vh;
                display:flex;
                font-family:Segoe UI, sans-serif;
                background:#f3f4f6;
            }

            .sidebar
            {
                width:220px;
                background:#1f2933;
                color:white;
                padding:20px;
            }

            .sidebar h2
            {
                text-align:center;
                margin-bottom:30px;
            }
            
            .sidebar button
            {
                width:100%;
                padding:12px;
                margin:8px 0;
                background:none;
                border:none;
                color:white;
                text-align:left;
                cursor:pointer;
                border-radius:8px;
            }

            .sidebar button:hover
            {
                background:#374151;
            }

            .logout
            {
                background:#b91c1c !important;
            }

            .content
            {
                flex:1;
                display:flex;
                justify-content:center;
                align-items:center;
            }

            .panel
            {
                background:white;
                padding:35px;
                width:420px;
                border-radius:18px;
                box-shadow:0 10px 25px rgba(0,0,0,.15);
            }

            .form-group
            {
                margin-bottom:14px;
            }

            label
            {
                font-weight:600;
                font-size:14px;
            }

            input
            {
                width:100%;
                padding:10px;
                border-radius:10px;
                border:1px solid #d1d5db;
            }

            .btn
            {
                width:100%;
                padding:11px;
                border:none;
                border-radius:10px;
                font-weight:600;
                cursor:pointer;
                margin-top:10px;
            }

            .btn-primary
            {
                background:#2563eb;
                color:white;
            }

            .btn-secondary
            {
                background:#374151;
                color:white;
            }

            .btn-danger
            {
                background:#b91c1c;
                color:white;
            }

            .divider
            {
                height:1px;
                background:#e5e7eb;
                margin:20px 0;
            }

            .modal-bg
            {
                position:fixed;
                inset:0;
                background:rgba(0,0,0,.6);
                display:none;
                justify-content:center;
                align-items:center;
                z-index:1000;
            }

            .modal
            {
                background:white;
                padding:30px;
                width:360px;
                border-radius:16px;
                box-shadow:0 15px 30px rgba(0,0,0,.3);
            }

            .modal h4
            {
                margin-top:0;
            }

            .modal-actions
            {
                display:flex;
                gap:10px;
                margin-top:18px;
            }

            .modal-actions button
            {
                flex:1;
            }

        </style>
    </head>
    <body>
        <div class="sidebar">
            <h2>√úye Paneli</h2>
            <button onclick="window.location.href='{{url_for('user.kitaplarSayfasi')}}'">üìö Kitaplar</button>
            <button onclick="window.location.href='{{url_for('user.kitaplarim')}}'">üìñ Kitaplarƒ±m</button>
            <button>‚ö†Ô∏è Ceza Bilgi</button>
            <button onclick="window.location.href='{{ url_for('user.islemGecmisi') }}'">üßæ ƒ∞≈ülem Ge√ßmi≈üi</button>
            <button onclick="window.location.href='{{url_for('user.memberInfo')}}'">‚öôÔ∏è Hesap Bilgileri</button>
            <button class="logout" onclick="window.location.href='{{url_for('user.logout')}}'">üö™ √áƒ±kƒ±≈ü</button>
        </div>

        <div class="content">
            <div class="panel">
                <h3>‚öôÔ∏è Hesap Bilgileri</h3>
                <div class="form-group">
                    <label>Kullanƒ±cƒ± Adƒ±</label>
                    <input id="username" value="{{ member.username if member else '' }}">
                </div>
                <div class="form-group">
                    <label>E-posta</label>
                    <input id="email" value="{{ member.email if member else '' }}">
                </div>

                <button class="btn btn-primary" onclick="saveProfile()">Kaydet</button>

                <div class="divider"></div>
                <button class="btn btn-secondary" onclick="openPassword()">üîí ≈ûifre Deƒüi≈ütir</button>
                <button class="btn btn-danger" onclick="openDelete()">‚ö†Ô∏è Hesabƒ± Sil</button>

            </div>
        </div>
        <div class="modal-bg" id="passwordModal">
            <div class="modal">
                <h4>≈ûifre Deƒüi≈ütir</h4>
                <input type="password" id="oldPass" placeholder="Eski ≈üifre">
                <input type="password" id="newPass" placeholder="Yeni ≈üifre">
                <input type="password" id="newPass2" placeholder="Yeni ≈üifre (tekrar)">

                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeModals()">ƒ∞ptal</button>
                    <button class="btn btn-primary" onclick="changePassword()">G√ºncelle</button>
                </div>
            </div>
        </div>
        <div class="modal-bg" id="deleteModal">
            <div class="modal">
                <h4>Hesabƒ± Sil</h4>
                <p style="font-size:14px;color:#6b7280">
                Bu i≈ülem geri alƒ±namaz.
                </p>
                <input type="password" id="deletePass" placeholder="≈ûifre">

                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeModals()">ƒ∞ptal</button>
                    <button class="btn btn-danger" onclick="deleteAccount()">Sil</button>
                </div>
            </div>
        </div>
        <script>
            function openPassword()
            {
                document.getElementById("passwordModal").style.display="flex";
            }

            function openDelete()
            {
                document.getElementById("deleteModal").style.display="flex";
            }

            function closeModals()
            {
                document.querySelectorAll(".modal-bg").forEach(m=>m.style.display="none");
            }

        function sha256Hex(str)
        {
            const enc = new TextEncoder();
            const data = enc.encode(str);
            return crypto.subtle.digest('SHA-256', data).then(function(hashBuffer){
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(function(b){ return b.toString(16).padStart(2,'0'); }).join('');
            });
        }

            function changePassword()
            {
                const oldP = oldPass.value;
                const newP = newPass.value;
                const newP2 = newPass2.value;

                function doChange()
                {
                    var p1 = oldP ? sha256Hex(oldP) : Promise.resolve("");
                    var p2 = newP ? sha256Hex(newP) : Promise.resolve("");
                    var p3 = newP2 ? sha256Hex(newP2) : Promise.resolve("");
                    return Promise.all([p1,p2,p3]).then(function(vals)
                    {
                        var oldH = vals[0], newH = vals[1], newH2 = vals[2];
                        return fetch("/kullaniciSifreDegistir",{
                            method:"POST",
                            headers:{"Content-Type":"application/json"},
                            credentials: 'include',
                            body:JSON.stringify({
                                old_password: oldH,
                                new_password: newH,
                                new_password_confirm: newH2
                            })
                        });
                    });
                }
                    
                doChange()
                .then(function(res){
                    return res.json();
                })
                .then(function(data){
                    alert(data.message);
                    if(data.success){
                        closeModals();
                    }
                })
                .catch(function(err){
                    console.error(err);
                    alert("Bir hata olu≈ütu");
                });
            }

            function deleteAccount()
            {
                if(!confirm("Emin misiniz?")) 
                {
                    return;
                }

                var p = deletePass.value ? sha256Hex(deletePass.value) : Promise.resolve("");
                p.then(function(passHash){
                    return fetch("/kullaniciSil",{
                        method:"POST",
                        headers:{"Content-Type":"application/json"},
                        credentials: 'include',
                        body:JSON.stringify({ password: passHash })
                    });
                })
                .then(function(res){
                    return res.json();
                })
                .then(function(data){
                    if(data.success)
                    {
                        window.location.href = "/";
                    }
                    else
                    {
                        alert(data.message);
                    }
                })
                .catch(function(err){
                    console.error(err);
                    alert("Bir hata olu≈ütu");
                });
            }

            function saveProfile()
            {
                fetch("/kullaniciProfilGuncelle",{
                    method:"POST",
                    headers:{"Content-Type":"application/json"},
                    credentials: 'include',
                    body:JSON.stringify({
                        username: document.querySelector("#username").value,
                        email: document.querySelector("#email").value
                    })
                })
                .then(res => res.json())
                .then(data => {
                    alert(data.message);
                });
            }
        </script>
    </body>
</html>
