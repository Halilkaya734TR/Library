<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Admin | Kitap Ä°ÅŸlemleri</title>
    <style>
        *
        {
            box-sizing:border-box;
        }

        body
        {
            margin:0;
            height:100vh;
            display:flex;
            font-family:Segoe UI, sans-serif;
            background:#f3f4f6;
        }

        .sidebar
        {
            width:240px;
            background:#111827;
            color:white;
            padding:20px;
        }

        .sidebar h2
        {
            text-align:center;
            margin-bottom:25px;
        }

        .sidebar button
        {
            width:100%;
            padding:12px;
            margin:6px 0;
            background:none;
            border:none;
            color:white;
            text-align:left;
            cursor:pointer;
            border-radius:10px;
        }

        .sidebar button:hover
        {
            background:#1f2937;
        }
        
        .logout
        {
            background:#991b1b !important;
        }

        .content
        {
            flex:1;
            padding:25px;
            display:flex;
            flex-direction:column;
            position:relative;
        }

        .page-title
        {
            font-size:26px;
            margin-bottom:12px;
        }

        .table-box
        {
            flex:1;
            background:white;
            border-radius:16px;
            box-shadow:0 6px 18px rgba(0,0,0,.15);
            overflow:auto;
        }

        table
        {
            width:100%;
            border-collapse:collapse;
        }

        th,td
        {
            padding:12px 14px;
            border-bottom:1px solid #e5e7eb;
        }

        th
        {
            background:#2563eb;
            color:white;
        }
        tr:nth-child(even)
        {
            background:#f9fafb;
        }

        .bottom-bar
        {
            margin-top:14px;
            background:white;
            padding:16px;
            border-radius:16px;
            box-shadow:0 4px 12px rgba(0,0,0,.15);
            display:flex;
            align-items:center;
            gap:10px;
        }

        input,select
        {
            height:42px;
            padding:0 14px;
            border-radius:10px;
            border:1px solid #cbd5e1;
        }

        .btn
        {
            padding:10px 18px;
            border:none;
            border-radius:10px;
            color:white;
            cursor:pointer;
        }

        .add
        {
            background:#16a34a;
        }

        .edit
        {
            background:#f59e0b;
        }

        .delete
        {
            background:#dc2626;
        }

        .page-btn
        {
            background:#2563eb;
        }

        .page-btn:disabled
        {
            background:#94a3b8;
        }

        .modal-bg
        {
            position:absolute;
            inset:0;
            background:rgba(0,0,0,.35);
            display:none;
            justify-content:center;
            align-items:center;
            z-index:999;
        }

        .modal
        {
            background:white;
            width:420px;
            padding:24px;
            border-radius:18px;
            position:relative;
            z-index:1000;
        }

        .modal input,.modal select
        {
            width:100%;
            margin-bottom:12px;
        }

        .modal-actions
        {
            display:flex;
            justify-content:flex-end;
            gap:10px;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>Admin Paneli</h2>
        <button onclick="window.location.href='{{url_for('admin.kitapÄ°slemler')}}'">ğŸ“š Kitap Ä°ÅŸlemleri</button>
        <button onclick="window.location.href='{{url_for('admin.yazarlar')}}'">âœï¸ Yazar Ä°ÅŸlemleri</button>
        <button onclick="window.location.href='{{url_for('admin.kategoriler')}}'">ğŸ“‚ Kategori Ä°ÅŸlemleri</button>
        <button onclick="window.location.href='{{url_for('admin.yayinevi')}}'">ğŸ“– YayÄ±nevi Ä°ÅŸlemleri</button>
        <button onclick="window.location.href='{{url_for('admin.cezalar')}}'">â›” KÃ¼tÃ¼phane CezalarÄ±</button>
        <button onclick="window.href='{{url_for('admin.kullanicilar')}}'">ğŸ‘¤ KullanÄ±cÄ±lar</button>
        <button onclick="window.location.href='{{url_for('admin.loglar')}}'">ğŸ§¾ KÃ¼tÃ¼phane LoglarÄ±</button>
        <button onclick="window.location.href='{{url_for('admin.adminler')}}'">ğŸ‘¨â€ğŸ’¼ Adminler</button>
        <button onclick="window.location.href='{{url_for('admin.adminInfo')}}'">âš™ï¸ Hesap Bilgileri</button>
        <button class="logout" onclick="window.location.href='{{url_for('admin.logout')}}'">ğŸšª Ã‡Ä±kÄ±ÅŸ</button>
    </div>

    <div class="content">

        <div class="page-title">âœï¸ Yazar Ä°ÅŸlemleri</div>

        <div class="table-box" id="yazarTablosu">
            <p style="padding:20px">Yazarlar yÃ¼kleniyor...</p>
        </div>

        <div class="bottom-bar">
            <button class="btn page-btn" id="prevBtn" disabled>â—€</button>
            <button class="btn page-btn" id="nextBtn">â–¶</button>

            <input type="text" id="arama" placeholder="Yazar ara..." oninput="filtrele();">

            <button class="btn add" onclick="ekleModal();">Ekle</button>
            <button class="btn edit" onclick="duzenleModal();">DÃ¼zenle</button>
            <button class="btn delete" onclick="sil();">Sil</button>
        </div>

        <div class="modal-bg" id="modalBg">
            <div class="modal">
                <h3 id="modalTitle">Yazar Ekle</h3>
                <input type="hidden" id="authorID">
                <input type="text" id="authorName" placeholder="Yazar AdÄ±">
                <div class="modal-actions">
                    <button class="btn page-btn" onclick="modalKapat();">Ä°ptal</button>
                    <button class="btn add" onclick="kaydet();">Kaydet</button>
                </div>
            </div>
        </div>

        <div class="modal-bg" id="editModalBg">
            <div class="modal">
                <h3>Yazar DÃ¼zenle</h3>
                <input type="hidden" id="editAuthorID">
                <input type="text" id="editAuthorName" placeholder="Yazar AdÄ±">
                <div class="modal-actions">
                    <button class="btn page-btn" onclick="editModalKapat();">Ä°ptal</button>
                    <button class="btn edit" onclick="duzenleKaydet();">GÃ¼ncelle</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        let yazarlar = [];
        let filtre = [];
        let secilen = [];
        let sayfa = 0;
        const LIMIT = 10;

        let yazarTablosu;
        let prevBtn;
        let nextBtn;
        let arama;

        let modalBg;
        let modalTitle;
        let authorID;
        let authorName;

        let editModalBg;
        let editAuthorID;
        let editAuthorName;

        function yukle()
        {
            fetch("/admin/yazarlar")
            .then(r=>r.json())
            .then(d=>{
                yazarlar = d;
                filtre = d;
                sayfa = 0;
                secilen = [];
                tablo();
            });
        }

        function tablo()
        {
            let s = sayfa * LIMIT;
            let e = s + LIMIT;
            let liste = filtre.slice(s,e);

            let h = `<table><thead><tr>
            <th></th><th>Yazar AdÄ±</th>
            </tr></thead><tbody>`;

            liste.forEach(k=>{
                h += `<tr>
                <td><input type="checkbox" value="${k.authorID}" onchange="sec(this);"></td>
                <td>${k.authorName ?? ""}</td>
                </tr>`;
            });

            h += `</tbody></table>`;
            yazarTablosu.innerHTML = h;

            prevBtn.disabled = (sayfa == 0);
            nextBtn.disabled = (e >= filtre.length);
        }

        function sec(c)
        {
            let id = String(c.value);

            if(c.checked)
            {
                if(!secilen.includes(id)) secilen.push(id);
            }
            else
            {
                secilen = secilen.filter(x=>x!=id);
            }
        }

        function filtrele()
        {
            let a = (arama.value || "").toLowerCase();
            filtre = yazarlar.filter(k => (k.authorName || "").toLowerCase().includes(a));
            sayfa = 0;
            tablo();
        }

        function ekleModal()
        {
            modalTitle.innerText = "Yazar Ekle";
            authorID.value = "";
            authorName.value = "";
            modalBg.style.display = "flex";
        }

        function duzenleModal()
        {
            if(secilen.length != 1)
            {
                alert("DÃ¼zenlemek iÃ§in 1 yazar seÃ§in");
                return;
            }

            let id = secilen[0];
            let y = yazarlar.find(x => String(x.authorID) == String(id));

            if(!y)
            {
                alert("Yazar bulunamadÄ±");
                return;
            }

            editAuthorID.value = y.authorID;
            editAuthorName.value = y.authorName;
            editModalBg.style.display = "flex";
        }

        function kaydet()
        {
            let url = "/yazarEkle";

            fetch(url,{
                method:"POST",
                headers:{ "Content-Type":"application/json" },
                body:JSON.stringify({
                    authorName: authorName.value
                })
            }).then(()=>{
                modalKapat();
                yukle();
            });
        }

        function duzenleKaydet()
        {
            fetch("/yazarDuzenleme",{
                method:"POST",
                headers:{ "Content-Type":"application/json" },
                body:JSON.stringify({
                    authorID: editAuthorID.value,
                    authorName: editAuthorName.value
                })
            }).then(()=>{
                editModalKapat();
                secilen = [];
                yukle();
            });
        }

        function sil()
        {
            if(secilen.length == 0)
            {
                alert("Yazar seÃ§in");
                return;
            }

            fetch("/yazarSilme", {
                method: "POST",
                headers: { "Content-Type":"application/json" },
                body: JSON.stringify({ ids: secilen })
            })
            .then(r => r.json())
            .then(d => {
                if(d.error){
                    alert(d.error);
                    return;
                }
                secilen = [];
                yukle();
            });
        }

        function modalKapat()
        {
            modalBg.style.display = "none";
        }

        function editModalKapat()
        {
            editModalBg.style.display = "none";
        }

        window.onload = ()=>{
            yazarTablosu = document.getElementById("yazarTablosu");
            prevBtn = document.getElementById("prevBtn");
            nextBtn = document.getElementById("nextBtn");
            arama = document.getElementById("arama");

            modalBg = document.getElementById("modalBg");
            modalTitle = document.getElementById("modalTitle");
            authorID = document.getElementById("authorID");
            authorName = document.getElementById("authorName");

            editModalBg = document.getElementById("editModalBg");
            editAuthorID = document.getElementById("editAuthorID");
            editAuthorName = document.getElementById("editAuthorName");

            prevBtn.onclick = ()=>{
                if(sayfa > 0)
                {
                    sayfa--;
                    tablo();
                }
            };

            nextBtn.onclick = ()=>{
                if((sayfa + 1) * LIMIT < filtre.length)
                {
                    sayfa++;
                    tablo();
                }
            };

            yukle();
        };
    </script>
</body>
</html>